{"version":3,"file":"polystate.min.js","sources":["../src/polystate.js"],"sourcesContent":["// <body>\n//   <button data-click-to-toggle-class=\"menu-open\">toggle</button>\n//   <aside data-click-away-to-remove-class=\"menu-open\" data-show-if=\".menu-open\">menu</aside>\n// </body>\n\n// data-click-to-add-class=\"className .selector(optional)\"\n// data-click-away-to-add-class=\"className .selector(optional)\"\n// data-click-to-remove-class=\"className .selector(optional)\"\n// data-click-away-to-remove-class=\"className .selector(optional)\"\n// data-click-to-toggle-class=\"className .selector(optional)\"\n// data-click-away-to-toggle-class=\"className .selector(optional)\"\n\n// data-hide-if=\".menu-open\" \n  // hides element if it or any ancestor element has class \"menu-open\"\n// data-show-if=\".menu-open\"\n  // shows element ONLY if it or any ancestor element has class \"menu-open\"\n\n  // generate visibility styles automatically using JS\n\n// don't trigger click away actions if there's a click action affecting \n//   the same class OR the same class and selector\n\n(function () {\n  let clickSelectors = [\n    \"[data-click-to-add-class]\",\n    \"[data-click-to-remove-class]\",\n    \"[data-click-to-toggle-class]\"\n  ];\n\n  let clickAwaySelectors = [\n    \"[data-click-away-to-add-class]\",\n    \"[data-click-away-to-remove-class]\",\n    \"[data-click-away-to-toggle-class]\"\n  ];\n\n  let actionFunctionLookup = {\n    \"[data-click-to-add-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"add\"});\n    },\n    \"[data-click-away-to-add-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"add\"});\n    },\n    \"[data-click-to-remove-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"remove\"});\n    },\n    \"[data-click-away-to-remove-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"remove\"});\n    },\n    \"[data-click-to-toggle-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"toggle\"});\n    },\n    \"[data-click-away-to-toggle-class]\": ({selector, className}) => {\n      manipulateClass({selector, className, actionType: \"toggle\"});\n    }\n  };\n\n  function manipulateClass ({selector, className, actionType}) {\n    let elems = Array.from(document.querySelectorAll(selector));\n\n    elems.forEach(elem => {\n      if (actionType === \"remove\" || actionType === \"toggle\" && elem.classList.contains(className)) {\n        elem.classList.remove(className);\n      } else if (actionType === \"add\" || actionType === \"toggle\" && !elem.classList.contains(className)) {\n        elem.classList.add(className);\n      }\n    });\n  }\n\n  document.addEventListener(\"click\", (event) => {\n    let clickActions = getAllClickActions(event.target, clickSelectors.join(\",\"));\n    // console.log(\"clickActions\", clickActions);\n    clickActions.forEach(clickAction => clickAction.actionFunc(clickAction.actionArgs));\n\n    let clickAwayActions = getAllClickAwayActions(event.target, clickActions);\n    // console.log(\"clickAwayActions\", clickAwayActions);\n    clickAwayActions.forEach(clickAwayAction => clickAwayAction.actionFunc(clickAwayAction.actionArgs));\n  });\n\n  function getAllClickActions (elem, selector) {\n    let parent = elem.parentNode;\n    let actions = [];\n\n    if (!selector || elem.matches(selector)) {\n      let actionDetails = getActionDetailsFromElem(elem, clickSelectors);\n      actions = actions.concat(actionDetails);\n    }\n\n    while (parent !== document) {\n      if (!selector || parent.matches(selector)) {\n        let actionDetails = getActionDetailsFromElem(parent, clickSelectors);\n        actions = actions.concat(actionDetails);\n      }\n      parent = parent.parentNode;\n    }\n\n    return actions;\n  }\n\n  function getActionDetailsFromElem (elem, selectorsList) {\n    let matchingSelectors = getMatchingSelectors(elem, selectorsList);\n    return matchingSelectors.map(selector => {\n      let attrName = selector.replace(/^\\[+|\\]+$/g, \"\");\n      let attrValue = elem.getAttribute(attrName);\n      let actionArgs = getArgsFromString(attrValue);\n      let actionFunc = actionFunctionLookup[selector];\n      return {elem, selector, attrName, attrValue, actionArgs, actionFunc};\n    });\n  }\n\n  function getAllClickAwayActions (clickedElem, clickActions) {\n    let clickedElems = getSelfAndAllAncestors(clickedElem);\n    let clickAwayElems = Array.from(document.querySelectorAll(clickAwaySelectors.join(\",\")));\n    let clickAwayElemsNotClickedOn = clickAwayElems.filter(el => !clickedElems.includes(el));\n\n    return clickAwayElemsNotClickedOn.reduce((arr, elem) => {\n      let actionDetails = getActionDetailsFromElem(elem, clickAwaySelectors);\n      // filter out matching actions (same selector and class name) \n      // that have already been triggered by click actions\n      let actionDetailsFiltered = actionDetails.filter(awayAction => {\n        let matchingClickAction = clickActions.find(clickAction => {\n          let selectorMatch = clickAction.actionArgs.selector === awayAction.actionArgs.selector;\n          let classMatch = clickAction.actionArgs.className === awayAction.actionArgs.className;\n          return selectorMatch && classMatch;\n        });\n        return !matchingClickAction;\n      });\n      return arr.concat(actionDetailsFiltered);\n    }, []);\n  }\n\n  function getSelfAndAllAncestors (elem) {\n    let parents = [elem];\n    let parent = elem.parentNode;\n    while (parent !== document) {\n      parents.push(parent);\n      parent = parent.parentNode;\n    }\n    return parents;\n  }\n\n  function getMatchingSelectors (elem, selectors) {\n    return selectors.filter(selector => elem.matches(selector));\n  }\n\n  function getArgsFromString (str) {\n    let args = str.split(\" \");\n    if (args.length === 1) {\n      args.push(\"body\");\n    }\n    let [className, selector] = args;\n    return {selector, className};\n  }\n\n  let visibilityStyles = Array.from(document.querySelectorAll(\"[data-show-if], [data-hide-if]\")).map(showIfElem => {\n    let showSelector = showIfElem.getAttribute(\"data-show-if\");\n    let hideSelector = showIfElem.getAttribute(\"data-hide-if\");\n    let showStyles = \"\";\n    let hideStyles = \"\";\n\n    if (showSelector) {\n      showStyles = `${showSelector} [data-show-if=\"${showSelector}\"], ${showSelector}[data-show-if=\"${showSelector}\"] {display: block;} [data-show-if=\"${showSelector}\"] {display: none}`;\n    }\n\n    if (hideSelector) {\n      hideStyles = `${hideSelector} [data-hide-if=\"${hideSelector}\"], ${hideSelector}[data-hide-if=\"${hideSelector}\"] {display: none;}`;\n    }\n\n    return showStyles + hideStyles;\n  }).join(\"\");\n\n  document.head.insertAdjacentHTML(\"beforeend\", \"<style>\" + visibilityStyles + \"</style>\")\n})()\n\n\n\n\n\n\n\n\n"],"names":["clickSelectors","clickAwaySelectors","actionFunctionLookup","selector","className","manipulateClass","actionType","Array","from","document","querySelectorAll","forEach","elem","classList","contains","remove","add","getActionDetailsFromElem","selectorsList","selectors","filter","matches","getMatchingSelectors","map","attrName","replace","attrValue","getAttribute","actionArgs","str","args","split","length","push","getArgsFromString","actionFunc","addEventListener","event","clickActions","parent","parentNode","actions","actionDetails","concat","getAllClickActions","target","join","clickAction","clickedElem","clickedElems","parents","getSelfAndAllAncestors","el","includes","reduce","arr","actionDetailsFiltered","awayAction","find","selectorMatch","classMatch","getAllClickAwayActions","clickAwayAction","visibilityStyles","showIfElem","showSelector","hideSelector","showStyles","hideStyles","head","insertAdjacentHTML"],"mappings":"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"}